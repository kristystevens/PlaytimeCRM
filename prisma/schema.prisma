// PostgreSQL schema for production (Vercel-compatible)
// This uses PostgreSQL database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Note: Using String for enums to maintain compatibility with existing code
// PostgreSQL supports native enums, but we keep String for flexibility

model User {
  id           String   @id @default(uuid())
  name         String
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         String   // ADMIN, OPS, RUNNER, AGENT
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  runnerProfile Runner?
  agentProfile  Agent?
  activityLogs  ActivityLog[]

  @@map("users")
}

model Player {
  id                String   @id @default(uuid())
  telegramHandle    String   @unique @map("telegram_handle")
  ginzaUsername     String?  @map("ginza_username")
  walletAddress     String?  @unique @map("wallet_address")
  country           String?
  joinedAt          DateTime @default(now()) @map("joined_at")
  playerType        String   @default("PLAYER") @map("player_type") // PLAYER, RUNNER, AGENT
  vipTier           String   @default("MEDIUM") @map("vip_tier") // HIGH, MEDIUM, LOW
  status            String   @default("ACTIVE") // ACTIVE, FADING, CHURNED
  churnRisk         String   @default("LOW") @map("churn_risk") // LOW, MED, HIGH
  skillLevel        String   @default("AMATEUR") @map("skill_level") // WHALE, PRO, NIT, AMATEUR, PUNTER
  tiltRisk          Boolean  @default(false) @map("tilt_risk")
  preferredGames    Json     @default("[]") @map("preferred_games") // JSON array
  notes             String?
  assignedRunnerId  String?  @map("assigned_runner_id")
  referredByAgentId String?  @map("referred_by_agent_id")
  lastActiveAt      DateTime? @map("last_active_at")
  totalDeposited    Decimal  @default(0) @db.Decimal(18, 2) @map("total_deposited")
  totalWagered      Decimal  @default(0) @db.Decimal(18, 2) @map("total_wagered")
  netPnL            Decimal  @default(0) @db.Decimal(18, 2) @map("net_pnl")
  avgBuyIn          Decimal  @default(0) @db.Decimal(18, 2) @map("avg_buy_in")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  assignedRunner Runner?  @relation("PlayerRunner", fields: [assignedRunnerId], references: [id])
  referredByAgent Agent?  @relation("PlayerAgent", fields: [referredByAgentId], references: [id])
  runnerProfile   Runner? @relation("PlayerRunnerProfile")
  agentProfile    Agent?  @relation("PlayerAgentProfile")
  messageTasks    MessageTask[]
  playtimeEntries PlaytimeEntry[]

  @@index([telegramHandle])
  @@index([walletAddress])
  @@index([assignedRunnerId])
  @@index([referredByAgentId])
  @@index([lastActiveAt])
  @@index([status])
  @@index([vipTier])
  @@index([skillLevel])
  @@index([playerType])
  @@map("players")
}

model Runner {
  id                String   @id @default(uuid())
  userId            String?  @unique @map("user_id")
  playerId          String?  @unique @map("player_id") // Link to Player
  name              String
  telegramHandle    String   @unique @map("telegram_handle")
  ginzaUsername     String?  @map("ginza_username")
  timezone          String?
  languages         Json     @default("[]") // JSON array
  status            String   @default("TRUSTED") // TRUSTED, WATCH, CUT
  bankrollAccess    Boolean  @default(false) @map("bankroll_access")
  maxTableSize      Int      @default(6) @map("max_table_size")
  strikeCount       Int      @default(0) @map("strike_count")
  compType          String   @default("PERCENT") @map("comp_type") // PERCENT, FLAT
  compValue         Decimal  @default(0) @db.Decimal(18, 2) @map("comp_value")
  totalPaid         Decimal  @default(0) @db.Decimal(18, 2) @map("total_paid")
  outstandingBalance Decimal @default(0) @db.Decimal(18, 2) @map("outstanding_balance")
  notes             String?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  user            User?          @relation(fields: [userId], references: [id])
  player          Player?         @relation("PlayerRunnerProfile", fields: [playerId], references: [id], onDelete: Cascade)
  assignedPlayers Player[]       @relation("PlayerRunner")
  payouts         Payout[]

  @@index([telegramHandle])
  @@index([status])
  @@index([playerId])
  @@map("runners")
}

model Agent {
  id             String   @id @default(uuid())
  userId         String?  @unique @map("user_id")
  playerId       String?  @unique @map("player_id") // Link to Player
  name           String
  telegramHandle String   @unique @map("telegram_handle")
  ginzaUsername  String?  @map("ginza_username")
  timezone       String?  @map("timezone")
  primaryPlatform String  @default("TELEGRAM") @map("primary_platform") // TELEGRAM, DISCORD, TWITTER, OTHER
  status         String   @default("ACTIVE") // ACTIVE, INACTIVE, APPROACHING
  revSharePct    Decimal  @default(0) @db.Decimal(5, 2) @map("rev_share_pct")
  totalEarned    Decimal  @default(0) @db.Decimal(18, 2) @map("total_earned")
  totalPaid      Decimal  @default(0) @db.Decimal(18, 2) @map("total_paid")
  unpaidBalance  Decimal  @default(0) @db.Decimal(18, 2) @map("unpaid_balance")
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  user            User?            @relation(fields: [userId], references: [id])
  player          Player?           @relation("PlayerAgentProfile", fields: [playerId], references: [id], onDelete: Cascade)
  referredPlayers Player[]         @relation("PlayerAgent")
  payouts         Payout[]
  messageTasks    MessageTask[]

  @@index([telegramHandle])
  @@index([status])
  @@index([playerId])
  @@map("agents")
}

model ActivityLog {
  id         String   @id @default(uuid())
  actorUserId String  @map("actor_user_id")
  entityType String   @map("entity_type") // PLAYER, RUNNER, AGENT, PAYOUT, MESSAGETASK
  entityId   String   @map("entity_id")
  action     String   // CREATE, UPDATE, DELETE, ASSIGN, TAG, PAYOUT
  changes    Json?    // JSON object
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  actor User @relation(fields: [actorUserId], references: [id])

  @@index([actorUserId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("activity_logs")
}

model Payout {
  id         String   @id @default(uuid())
  payeeType  String   @map("payee_type") // RUNNER, AGENT
  payeeId    String   @map("payee_id")
  amount     Decimal  @db.Decimal(18, 2)
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")
  status     String   @default("PENDING") // PENDING, PAID, VOID
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  runnerId   String?  @map("runner_id")
  agentId     String?  @map("agent_id")
  runner     Runner?  @relation(fields: [runnerId], references: [id])
  agent      Agent?   @relation(fields: [agentId], references: [id])

  @@index([payeeType, payeeId])
  @@index([status])
  @@index([createdAt])
  @@index([runnerId])
  @@index([agentId])
  @@map("payouts")
}

model MessageTask {
  id         String    @id @default(uuid())
  playerId   String?   @map("player_id")
  agentId    String?   @map("agent_id")
  runnerId   String?   @map("runner_id")
  channel    String    // TELEGRAM, WHATSAPP, EMAIL, OTHER
  template   String    // WHALE_CHECKIN, REVIVE, FOLLOWUP
  status     String    @default("TODO") // TODO, SENT, SKIPPED
  dueAt      DateTime? @map("due_at")
  notes      String?
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  // Relations
  player Player? @relation(fields: [playerId], references: [id])
  agent  Agent?  @relation(fields: [agentId], references: [id])

  @@index([status])
  @@index([dueAt])
  @@index([playerId])
  @@index([agentId])
  @@index([runnerId])
  @@map("message_tasks")
}

model PlaytimeEntry {
  id        String   @id @default(uuid())
  playerId  String   @map("player_id")
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  // Date the play happened (stored as DateTime, normalized to midnight UTC)
  playedOn  DateTime @map("played_on")

  // Start and end times for the playtime session (HH:mm format)
  startTime String?  @map("start_time")
  endTime   String?  @map("end_time")

  // Minutes played for that date
  minutes   Int      @default(0)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([playerId, playedOn])
  @@index([playerId, playedOn])
  @@map("playtime_entries")
}

